# AI 编程工具移动化 - 技术设计文档

**文档日期**：2026年2月25日
**版本**：v1.0

---

## 一、系统架构

```
┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐
│   移动端 H5      │     │   云端服务       │     │   桌面端         │
│                  │◄───►│                  │◄───►│  (Desktop Agent) │
│ - 终端输出显示   │     │ - 用户/设备管理  │     │                  │
│ - 指令输入       │     │ - 会话管理       │     │ - 启动 AI 工具   │
│ - 状态监控       │     │ - 消息转发       │     │ - PTY 终端捕获   │
└──────────────────┘     │ - WebSocket     │     │ - 指令注入       │
                         │ - H5 静态资源   │     └──────────────────┘
                         └──────────────────┘
```

---

## 二、技术选型

| 组件 | 技术选型 | 说明 |
|------|---------|------|
| **云端服务** | Go + WebSocket | 用户管理、设备绑定、消息路由 |
| **Desktop Agent** | Go (复用 agentapi) | 启动 AI 工具、终端捕获 |
| **移动端 H5** | Next.js | 终端显示、指令输入 |

---

## 三、核心模块设计

### 3.1 云端服务

**功能**：
- 用户注册/登录
- 设备绑定管理（扫码/绑定码）
- WebSocket 连接管理
- 消息路由转发

**核心 API**：
- `POST /auth/register` - 用户注册
- `POST /auth/login` - 用户登录
- `POST /device/bind` - 设备绑定
- `GET /device/qrcode` - 获取绑定二维码
- `WS /ws` - WebSocket 连接

### 3.2 Desktop Agent

**功能**：
- 启动 AI 编程工具（Claude Code 等）
- PTY 终端输出捕获
- 接收指令并注入终端
- 保持与云端的长连接

**与现有 agentapi 关系**：
- 复用 `lib/termexec` - PTY 终端管理
- 复用 `lib/screentracker` - 屏幕快照和消息解析
- 新增 WebSocket 客户端连接到云端

### 3.3 移动端 H5

**功能**：
- 终端输出实时显示
- 指令输入和发送
- 设备状态监控
- 绑定流程

---

## 四、数据流

```
桌面端 (Desktop Agent)              云端服务                   移动端 H5
      │                               │                          │
      │──── 终端输出 (WebSocket) ────>│                          │
      │                               │──── 终端输出 (WS) ──────>│
      │                               │                          │
      │<─── 指令 (WebSocket) ────────│<─── 用户输入 ────────────│
      │                               │                          │
```

---

## 五、认证流程

```
1. 桌面端启动 → 生成设备绑定码/二维码
2. 移动端 H5 扫码/输入绑定码 → 关联设备
3. 云端建立 WebSocket 长连接
4. 消息通过设备关联路由
```

---

## 六、MVP 功能范围

| 功能 | 说明 |
|------|------|
| 终端内容映射 | 桌面端 AI 工具输出实时显示在 H5 |
| 指令发送 | H5 输入指令发送到桌面端 |
| 设备绑定 | 扫码/绑定码关联桌面和移动端 |

---

## 七、与现有 agentapi 的关系

**复用**：
- `lib/termexec` - PTY 终端管理
- `lib/screentracker` - 屏幕快照和消息解析
- `lib/msgfmt` - 消息格式化
- `chat/` - H5 前端基础

**新增**：
- 云端服务（用户管理、设备绑定）
- Desktop Agent（WebSocket 客户端）
- 移动端 H5（设备绑定流程、终端显示）

---

## 八、实施阶段

### Phase 1: 基础架构
- 云端服务搭建
- Desktop Agent 原型
- 基础 WebSocket 通信

### Phase 2: 设备绑定
- 扫码/绑定码功能
- 用户认证
- 设备管理

### Phase 3: 移动端 H5
- 终端显示
- 指令输入
- 状态监控

---

*本文档为技术设计初稿，具体实现时可能调整。*
